{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">ğŸ“ AI ç„¡é™å–®å­—æ¸¬é©—</h4>
            </div>
            <div class="card-body">
                
                <div id="level-selector" class="text-center mb-4">
                    <p class="lead">è«‹é¸æ“‡è¦æŒ‘æˆ°çš„ç­‰ç´šï¼š</p>
                    <button onclick="startQuiz('N5')" class="btn btn-outline-success m-1">N5</button>
                    <button onclick="startQuiz('N4')" class="btn btn-outline-success m-1">N4</button>
                    <button onclick="startQuiz('N3')" class="btn btn-outline-success m-1">N3</button>
                    <button onclick="startQuiz('N2')" class="btn btn-outline-success m-1">N2</button>
                    <button onclick="startQuiz('N1')" class="btn btn-outline-success m-1">N1</button>
                </div>

                <div id="loading" class="text-center d-none py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">AI è€å¸«æ­£åœ¨ç¿»æ›¸å‡ºé¡Œä¸­...ğŸ§ </p>
                </div>

                <div id="quiz-area" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-secondary" id="current-level-tag">N?</span>
                        <span class="text-muted">å–®é¸é¡Œ</span>
                    </div>
                    
                    <h3 id="question-text" class="mb-4 fw-bold">é¡Œç›®è¼‰å…¥ä¸­...</h3>
                    
                    <div class="d-grid gap-2" id="options-container">
                        </div>
                </div>

                <div id="result-area" class="d-none mt-4 pt-4 border-top">
                    <h4 id="result-title" class="fw-bold"></h4>
                    <div class="alert alert-light border" id="explanation-text"></div>
                    <button onclick="fetchQuestion()" class="btn btn-primary w-100 mt-2">ä¸‹ä¸€é¡Œ â¡</button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    let currentLevel = 'N3';
    let currentAnswer = '';

    function startQuiz(level) {
        currentLevel = level;
        document.getElementById('current-level-tag').innerText = level;
        document.getElementById('level-selector').classList.add('d-none');
        fetchQuestion();
    }

    function fetchQuestion() {
        // UI é‡ç½®
        document.getElementById('quiz-area').classList.add('d-none');
        document.getElementById('result-area').classList.add('d-none');
        document.getElementById('loading').classList.remove('d-none');

        // å‘¼å«å¾Œç«¯ API
        fetch('/api/quiz/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ level: currentLevel })
        })
        .then(response => response.json())
        .then(data => {
            if(data.error) {
                alert('å‡ºéŒ¯äº†ï¼š' + data.error);
                // å¦‚æœå‡ºéŒ¯ï¼ŒæŠŠ Loading è—èµ·ä¾†ï¼Œé¡¯ç¤ºå›é¸å–®
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('level-selector').classList.remove('d-none');
                return;
            }
            renderQuestion(data);
        })
        .catch(err => {
            console.error(err);
            alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('level-selector').classList.remove('d-none');
        });
    }

    function renderQuestion(data) {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('quiz-area').classList.remove('d-none');
        
        document.getElementById('question-text').innerText = data.question;
        currentAnswer = data.answer; // é€™è£¡å­˜çš„æ˜¯å¾Œç«¯å‚³ä¾†çš„æ­£ç¢ºç­”æ¡ˆæ–‡å­—
        
        const container = document.getElementById('options-container');
        container.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

        data.options.forEach(option => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-dark text-start p-3 fs-5';
            btn.innerText = option;
            // é»æ“Šæ™‚ï¼ŒæŠŠã€ŒæŒ‰éˆ•ä¸Šçš„æ–‡å­— (option)ã€è·Ÿã€Œæ­£ç¢ºç­”æ¡ˆ (data.answer)ã€åšæ¯”å°
            btn.onclick = () => checkAnswer(btn, option, data.explanation);
            container.appendChild(btn);
        });
    }

    function checkAnswer(btnElement, selected, explanation) {
        // é–å®šæ‰€æœ‰æŒ‰éˆ•ä¸èƒ½å†æŒ‰
        const allBtns = document.querySelectorAll('#options-container button');
        allBtns.forEach(btn => btn.disabled = true);

        const resultArea = document.getElementById('result-area');
        const resultTitle = document.getElementById('result-title');
        const explanationText = document.getElementById('explanation-text');
        
        resultArea.classList.remove('d-none');
        explanationText.innerText = explanation;

        let score = 0;

        // é€™è£¡å°±æ˜¯é—œéµï¼šæ–‡å­—æ¯”å°
        if (selected === currentAnswer) {
            // ç­”å°
            btnElement.classList.remove('btn-outline-dark');
            btnElement.classList.add('btn-success');
            resultTitle.innerHTML = "ğŸ‰ æ­£è§£ï¼å¤ªæ£’äº†ï¼";
            resultTitle.className = "fw-bold text-success";
            score = 100;
        } else {
            // ç­”éŒ¯
            btnElement.classList.remove('btn-outline-dark');
            btnElement.classList.add('btn-danger');
            
            // æ¨™ç¤ºå‡ºæ­£ç¢ºç­”æ¡ˆæ˜¯å“ªå€‹
            allBtns.forEach(btn => {
                if (btn.innerText === currentAnswer) {
                    btn.classList.remove('btn-outline-dark');
                    btn.classList.add('btn-success');
                }
            });

            resultTitle.innerHTML = "ğŸ˜¢ ç­”éŒ¯äº†... æ­£ç¢ºç­”æ¡ˆæ˜¯ " + currentAnswer;
            resultTitle.className = "fw-bold text-danger";
            score = 0;
        }

        // æŠŠæˆç¸¾å­˜å›è³‡æ–™åº«
        saveScore(score);
    }

    function saveScore(score) {
        fetch('/api/quiz/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                level: currentLevel, 
                score: score 
            })
        });
    }
</script>
{% endblock %}